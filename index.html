<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Returns SLA & Capacity (Web)</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;--br:#253046}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:10px 0 4px} .lead{color:var(--muted)}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px}
  label{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-weight:700}
  input[type=number],input[type=text],input[type=date],select{width:100%;padding:8px 10px;border-radius:9px;border:1px solid var(--br);background:#0b1020;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .tile{background:#0b1020;border:1px solid var(--br);border-radius:10px;padding:10px}
  .num{font-size:22px;font-weight:800}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{border-bottom:1px solid var(--br);padding:6px 8px;text-align:left}
  .badge{font-weight:800;border-radius:999px;padding:3px 9px}
  .b-good{background:rgba(22,163,74,.15);color:#86efac;border:1px solid rgba(22,163,74,.4)}
  .b-warn{background:rgba(245,158,11,.12);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
  .b-bad{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
  button{border:1px solid var(--br);background:#22d3ee;color:#06252c;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer}
  button.out{background:transparent;color:var(--text)}
  .muted{color:var(--muted)} .hint{color:var(--muted);font-size:12px}
  /* Gate */
  #gate{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:20}
  #gate.hide{display:none!important}
  #gate .dlg{background:#0b1020;border:1px solid var(--br);border-radius:12px;padding:16px;max-width:360px;width:92%}
</style>
</head>
<body>
<div id="gate" class="hide">
  <div class="dlg">
    <h3 style="margin:0 0 8px">Who’s viewing?</h3>
    <p class="hint">Your name is logged with timestamps for the traffic log.</p>
    <input id="viewer" type="text" placeholder="e.g., Jamie L"/>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="enterBtn">Enter</button>
      <button id="enterCancel" class="out">Cancel</button>
    </div>
    <p id="gateWarn" class="hint" style="margin-top:8px"></p>
  </div>
</div>

<div class="wrap">
  <h1>Returns SLA & Capacity</h1>
  <p class="lead">Enter only: <b>UK pallets</b>, <b>INT pallets</b>, <b>oldest dates</b>, and <b>associates on shift</b>. We convert pallets → parcels → items and tell you how to staff to get back to <b>Green</b> (<b>&lt;5d</b>). Target processing rate = <b>30 items/h</b>.</p>

  <div class="grid">
    <div class="card">
      <h2>Inputs</h2>
      <div class="row">
        <div>
          <label>UK pallets</label>
          <input id="ukPallets" type="number" min="0" step="1" value="0"/>
        </div>
        <div>
          <label>INT pallets</label>
          <input id="intPallets" type="number" min="0" step="1" value="0"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Oldest UK date</label>
          <input id="ukDate" type="date"/>
        </div>
        <div>
          <label>Oldest INT date</label>
          <input id="intDate" type="date"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Domestic mix (Asda %)<span id="mixLbl" class="muted"></span></label>
          <input id="mix" type="range" min="0" max="100" step="5"/>
          <div class="hint">Asda pallet = 140 parcels • Evri pallet = 170 parcels • INT pallet = 140 parcels</div>
        </div>
        <div>
          <label>Lines per parcel</label>
          <input id="lpp" type="number" value="1.9" step="0.1" disabled/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Processing rate (items/h)</label>
          <input id="rate" type="number" value="30" disabled/>
        </div>
        <div>
          <label>FTE hours (per person)</label>
          <input id="fteH" type="number" value="11" disabled/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Associates @ 11h</label>
          <input id="assoc11" type="number" min="0" step="1" value="0"/>
        </div>
        <div>
          <label>Associates @ 6h</label>
          <input id="assoc6" type="number" min="0" step="1" value="0"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Max OT per associate (h)</label>
          <input id="maxOT" type="number" min="0" step="1" value="0"/>
        </div>
        <div></div>
      </div>
      <div style="margin-top:8px" class="hint">Changes update instantly. No Google/Apps Script needed.</div>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div class="kpi">
        <div class="tile"><div class="muted">Total items (UK)</div><div class="num" id="ukItems">—</div><div class="hint">from pallets</div></div>
        <div class="tile"><div class="muted">Total items (INT)</div><div class="num" id="intItems">—</div><div class="hint">from pallets</div></div>
        <div class="tile"><div class="muted">Hours to Green (UK)</div><div class="num" id="ukHrs">—</div><div class="hint">clear ≥5‑day items</div></div>
        <div class="tile"><div class="muted">Hours to Green (INT)</div><div class="num" id="intHrs">—</div><div class="hint">clear ≥5‑day items</div></div>
      </div>
      <div class="kpi" style="margin-top:8px">
        <div class="tile"><div class="muted">FTE to Green (UK)</div><div class="num" id="ukFTE">—</div><div class="hint">@ 11h</div></div>
        <div class="tile"><div class="muted">FTE to Green (INT)</div><div class="num" id="intFTE">—</div><div class="hint">@ 11h</div></div>
        <div class="tile"><div class="muted">Oldest Age (UK)</div><div class="num" id="ukAge">—</div><div id="ukBadge" class="hint"></div></div>
        <div class="tile"><div class="muted">Oldest Age (INT)</div><div class="num" id="intAge">—</div><div id="intBadge" class="hint"></div></div>
      </div>
      <table>
        <thead><tr><th>Summary</th><th>UK</th><th>INT</th></tr></thead>
        <tbody id="tbl"><tr><td>—</td><td></td><td></td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Plan for Today</h2>
      <div id="plan" class="muted">Enter pallets, dates & staffing to see the plan.</div>
    </div>

    <div class="card">
      <h2>Traffic Log</h2>
      <table>
        <thead><tr><th>When</th><th>User</th><th>Action</th><th>Note</th></tr></thead>
        <tbody id="log"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id); const fmt=n=>Number.isFinite(n)?Math.round(n).toLocaleString():"—";
  const P_ASDA=140, P_EVRI=170, P_INTL=140; const RATE=30, FTE_H=11; const LPP=1.9;
  const state={mix:50, viewer:"", ukDate:"", intDate:"", ukPallets:0, intPallets:0, assoc11:0, assoc6:0, maxOT:0};

  function badge(age){ if(age>=10) return ['b-bad','Red']; if(age>=5) return ['b-warn','Amber']; return ['b-good','Green']; }
  function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10);} 
  function daysSince(s){ if(!s) return 0; const d=new Date(s+'T00:00:00'); const t=new Date(); d.setHours(0,0,0,0); t.setHours(0,0,0,0); return Math.max(0,Math.round((t-d)/86400000)); }
  function fracOlder(age){ if(age<5) return 0; return Math.min(1, (age-4)/Math.max(1,age)); }

  function log(action,note=""){ try{ const row=[new Date().toISOString(), state.viewer||"(anon)", action, note]; addLogRow(row); localStorage.setItem('sla_log',(JSON.stringify((JSON.parse(localStorage.getItem('sla_log')||'[]')).concat([row]).slice(-500)))); }catch(e){} }
  function addLogRow(r){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]||''}</td>`; $('log').appendChild(tr); }
  function loadLog(){ try{ (JSON.parse(localStorage.getItem('sla_log')||'[]')).forEach(addLogRow);}catch(e){} }

  function setMix(v){ state.mix=+v||0; $('mix').value=v; $('mixLbl').textContent=` ${v}% Asda`; }

  function fillGate(){ let seen=null; try{ seen=localStorage.getItem('sla_viewer'); }catch(e){}
    if(seen){ state.viewer=seen; $('gate').classList.add('hide'); }
    else { $('gate').classList.remove('hide'); }
  }
  function closeGate(name){ state.viewer=name; try{ localStorage.setItem('sla_viewer',name);}catch(e){}
    $('gate').classList.add('hide'); log('enter'); }
  $('enterBtn').onclick=()=>{ const n=$('viewer').value.trim(); if(!n){ $('gateWarn').textContent='Name required'; return;} closeGate(n); };
  $('enterCancel').onclick=()=>{ $('gateWarn').textContent='Name required to view'; };
  $('viewer').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('enterBtn').click(); }});

  // Bind inputs → state → render
  ['ukPallets','intPallets','assoc11','assoc6','maxOT'].forEach(id=>$(id).addEventListener('input',()=>{ state[id]= +$(id).value||0; render(); }));
  ['ukDate','intDate'].forEach(id=>$(id).addEventListener('input',()=>{ state[id]= $(id).value; render(); }));
  $('mix').addEventListener('input',()=>{ setMix($('mix').value); render(); });

  function compute(){
    const pDom = (state.mix/100)*P_ASDA + (1-state.mix/100)*P_EVRI; const pInt=P_INTL;

    const ukItems = (state.ukPallets||0) * pDom * LPP;
    const intItems= (state.intPallets||0) * pInt * LPP;

    const ageUK  = daysSince(state.ukDate);
    const ageINT = daysSince(state.intDate);

    const riskFracUK  = fracOlder(ageUK);
    const riskFracINT = fracOlder(ageINT);

    const itemsRiskUK  = ukItems  * riskFracUK;
    const itemsRiskINT = intItems * riskFracINT;

    const hrsUK  = itemsRiskUK  / RATE;
    const hrsINT = itemsRiskINT / RATE;

    const baseHours = (state.assoc11||0)*11 + (state.assoc6||0)*6;
    const headcount = (state.assoc11||0) + (state.assoc6||0);
    const availHours = baseHours + headcount * (state.maxOT||0);
    const capacityItems = RATE * availHours;

    const needHours = hrsUK + hrsINT;
    const deficitHours = Math.max(0, needHours - availHours);
    const otPerAssoc = headcount>0 ? Math.ceil(Math.max(0, needHours - baseHours) / headcount) : 0;

    // Allocation rule: older stream first
    const olderFirst = ageUK >= ageINT ? 'UK' : 'INT';
    let allocUK=0, allocINT=0, rem=availHours;
    if(olderFirst==='UK'){ allocUK=Math.min(hrsUK,rem); rem-=allocUK; allocINT=Math.min(hrsINT,rem); }
    else { allocINT=Math.min(hrsINT,rem); rem-=allocINT; allocUK=Math.min(hrsUK,rem); }

    const fteUK_target  = Math.ceil(allocUK / 11);
    const fteINT_target = Math.ceil(allocINT / 11);

    return { ukItems,intItems,ageUK,ageINT,itemsRiskUK,itemsRiskINT,hrsUK,hrsINT,
      baseHours,headcount,availHours,capacityItems,deficitHours,otPerAssoc,fteUK_target,fteINT_target };
  }

  function render(){
    const r=compute();
    $('ukItems').textContent = fmt(r.ukItems); $('intItems').textContent = fmt(r.intItems);
    $('ukHrs').textContent = isFinite(r.hrsUK)? Math.ceil(r.hrsUK):'—';
    $('intHrs').textContent = isFinite(r.hrsINT)? Math.ceil(r.hrsINT):'—';
    $('ukFTE').textContent = isFinite(Math.ceil(r.hrsUK/11))? Math.ceil(r.hrsUK/11):'—';
    $('intFTE').textContent = isFinite(Math.ceil(r.hrsINT/11))? Math.ceil(r.hrsINT/11):'—';
    $('ukAge').textContent = r.ageUK||0; $('intAge').textContent = r.ageINT||0;
    const [c1,t1]=badge(r.ageUK), [c2,t2]=badge(r.ageINT);
    $('ukBadge').innerHTML = `<span class="badge ${c1}">${t1}</span>`;
    $('intBadge').innerHTML = `<span class="badge ${c2}">${t2}</span>`;

    $('tbl').innerHTML = `<tr><td>Oldest age (days)</td><td>${r.ageUK}</td><td>${r.ageINT}</td></tr>
      <tr><td>Pallets</td><td>${(state.ukPallets||0)}</td><td>${(state.intPallets||0)}</td></tr>
      <tr><td>Total items</td><td>${fmt(r.ukItems)}</td><td>${fmt(r.intItems)}</td></tr>
      <tr><td>Items ≥5d (to clear)</td><td>${fmt(r.itemsRiskUK)}</td><td>${fmt(r.itemsRiskINT)}</td></tr>`;

    const plan=[];
    plan.push(`Available person‑hours (incl. OT): <b>${Math.round(r.availHours)}</b> → capacity <b>${fmt(r.capacityItems)}</b> items.`);
    plan.push(`Work to reach <b>Green</b> today (clear ≥5‑day items): UK <b>${fmt(r.itemsRiskUK)}</b> items → <b>${fmt(Math.ceil(r.hrsUK))}</b> h; INT <b>${fmt(r.itemsRiskINT)}</b> items → <b>${fmt(Math.ceil(r.hrsINT))}</b> h.`);
    if(r.deficitHours<=0){
      plan.push(`<b>You can reach Green without extra FTE.</b> Allocate FTE (11h): UK <b>${r.fteUK_target}</b>, INT <b>${r.fteINT_target}</b> (prioritise the older stream first).`);
    } else {
      plan.push(`<b>Short by ${fmt(Math.ceil(r.deficitHours))} hours.</b> Options: add ~<b>${fmt(Math.ceil(r.deficitHours/11))}</b> FTE (11h) or schedule ~<b>${r.otPerAssoc}</b>h OT per associate.`);
    }
    plan.push(`Tactic: place 6h staff on the older stream first; move 11h staff across once it reaches ≤5d.`);

    $('plan').innerHTML = plan.join('<br>');
  }

  // Init
  (function init(){
    setMix(localStorage.getItem('mix')||50); try{$('mix').addEventListener('change',()=>localStorage.setItem('mix',state.mix));}catch(e){}
    $('ukDate').value = todayISO(); $('intDate').value=todayISO(); fillGate(); loadLog(); render();
  })();
})();
</script>
</body>
</html>
